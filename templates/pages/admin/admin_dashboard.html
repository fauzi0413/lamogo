{% extends "base.html" %}
{% block title %}Dashboard Admin{% endblock %}

{% block content %}
<div class="admin-container">
  {% include "sidebar.html" %}

  <main class="main-content">

    <!-- === INSIGHT CEPAT (dipindah ke atas) === -->
    <div class="alert alert-light border shadow-sm d-flex align-items-center gap-3 p-3 "
         style="background: #fffaf3; border-left: 6px solid #ff7b00;">
      <div class="fs-3 text-orange">üí°</div>
      <div>
        <h6 class="fw-bold text-orange mb-1">Insight Cepat</h6>
        <p class="mb-0 small text-dark">{{ insight_text | safe }}</p>
      </div>
    </div>

    <!-- === HEADER === -->
    <div class="header-actions my-3">
      <h2>Dashboard Admin</h2>
    </div>

    <!-- === KARTU STATISTIK UTAMA === -->
    <div class="row g-3">
      
      <div class="col-md-3 col-sm-6">
        <div class="card text-center shadow-sm border-0 rounded-3">
          <div class="card-body">
            <h6 class="text-orange fw-bold">Total Penjualan (per bulan)</h6>
            <p class="fs-5 mb-0">{{ total_sales|rupiah }}</p>
            {% if sales_growth > 0 %}
              <p class="small text-success"><i class="fas fa-arrow-up"></i> {{ "%.1f"|format(sales_growth) }}%</p>
            {% elif sales_growth < 0 %}
              <p class="small text-danger"><i class="fas fa-arrow-down"></i> {{ "%.1f"|format(sales_growth) }}%</p>
            {% else %}
              <p class="small text-muted"><i class="fas fa-minus"></i> 0.0%</p>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-md-3 col-sm-6">
        <div class="card text-center shadow-sm border-0 rounded-3">
          <div class="card-body">
            <h6 class="text-orange fw-bold">Rata-rata Transaksi (per bulan)</h6>
            <p class="fs-5 mb-0">{{ avg_order_value|rupiah }}</p>
            {% if avg_order_growth > 0 %}
              <p class="small text-success"><i class="fas fa-arrow-up"></i> {{ "%.1f"|format(avg_order_growth) }}%</p>
            {% elif avg_order_growth < 0 %}
              <p class="small text-danger"><i class="fas fa-arrow-down"></i> {{ "%.1f"|format(avg_order_growth) }}%</p>
            {% else %}
              <p class="small text-muted"><i class="fas fa-minus"></i> 0.0%</p>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-md-3 col-sm-6">
        <div class="card text-center shadow-sm border-0 rounded-3">
          <div class="card-body">
            <h6 class="text-orange fw-bold">Total Pesanan (per bulan)</h6>
            <p class="fs-5 mb-0">{{ total_orders }}</p>

            {% if orders_growth > 0 %}
              <p class="small text-success"><i class="fas fa-arrow-up"></i> {{ "%.1f"|format(orders_growth) }}%</p>
            {% elif orders_growth < 0 %}
              <p class="small text-danger"><i class="fas fa-arrow-down"></i> {{ "%.1f"|format(orders_growth) }}%</p>
            {% else %}
              <p class="small text-muted"><i class="fas fa-minus"></i> 0.0%</p>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-md-3 col-sm-6">
        <div class="card text-center shadow-sm border-0 rounded-3">
          <div class="card-body">
            <h6 class="text-orange fw-bold">Rata-rata Rating</h6>
            <p class="fs-5 mb-0">{{ "%.1f"|format(avg_rating) }}/5</p>
          </div>
        </div>
      </div>
      
      <div class="col-md-3 col-sm-6">
        <div class="card text-center shadow-sm border-0 rounded-3">
          <div class="card-body">
            <h6 class="text-orange fw-bold">Total User</h6>
            <p class="fs-5 mb-0">{{ total_users }}</p>
          </div>
        </div>
      </div>

      <div class="col-md-3 col-sm-6">
        <div class="card text-center shadow-sm border-0 rounded-3">
          <div class="card-body">
            <h6 class="text-orange fw-bold">Total Menu</h6>
            <p class="fs-5 mb-0">{{ total_menu }}</p>
          </div>
        </div>
      </div>
      
      <div class="col-md-3 col-sm-6">
        <div class="card text-center shadow-sm border-0 rounded-3">
          <div class="card-body">
            <h6 class="text-orange fw-bold">Jam Ramai (per bulan)</h6>
            <p class="fs-5 mb-0">{{ peak_hour or '-' }}</p>
          </div>
        </div>
      </div>

      <div class="col-md-3 col-sm-6">
        <div class="card text-center shadow-sm border-0 rounded-3">
          <div class="card-body">
            <h6 class="text-orange fw-bold">Menu Terlaris (per bulan)</h6>
            <p class="fs-5 mb-0">{{ top_menu_name or '-' }}</p>
            {% if top_menu_qty > 0 %}
              <p class="small text-muted">Terjual: {{ top_menu_qty }} kali</p>
            {% else %}
              <p class="small text-muted">Belum ada pesanan</p>
            {% endif %}
          </div>
        </div>
      </div> 

    </div>
 
    <!-- === STATISTIK PENJUALAN & PESANAN === -->
    <section class="mt-5">
      <div class="card shadow-sm border-0 rounded-3 mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <h5 class="fw-bold mb-0">üìä Statistik Penjualan</h5>
            <div class="btn-group" role="group" aria-label="Filter Grafik">
              <button class="btn btn-sm btn-filter" id="btnYear">Tahun</button>
              <button class="btn btn-sm btn-filter" id="btnMonth">Bulan</button>
              <button class="btn btn-sm btn-filter" id="btnWeek">Minggu</button>
              <button class="btn btn-sm btn-filter active" id="btnDay">Hari Ini</button>
            </div>
          </div>

          <p class="text-muted mb-2" id="summarySales">
            Total Penjualan: <strong>{{ daily_sales|default(0)|rupiah }}</strong>
          </p>

          <canvas id="salesChart" height="100"></canvas>
        </div>
      </div>

      <div class="card shadow-sm border-0 rounded-3">
        <div class="card-body">
          <h5 class="fw-bold mb-4">üßæ Jumlah Pesanan</h5>
          <p class="text-muted mb-2" id="summaryOrders">
            Total Pesanan: <strong>{{ daily_orders }}</strong> Order
          </p>
          <canvas id="ordersChart" height="100"></canvas>
        </div>
      </div>
    </section>

    <!-- === PIE CHART MENU TERLARIS === -->
    <div class="card shadow-sm border-0 rounded-3 mt-4">
      <div class="card-body">
        <h5 class="fw-bold mb-4">üçΩÔ∏è Distribusi Menu Terjual</h5>
        <div class="d-flex align-items-center justify-content-center flex-column flex-md-row gap-3 gap-md-2">
          <div class="chart-container flex-shrink-0" style="width: 300px; height: 300px;">
            <canvas id="menuChart"></canvas>
          </div>
          <ul class="list-unstyled text-start mb-0 ms-md-3" id="menuList"></ul>
        </div>
      </div>
    </div>

    <!-- === GRAFIK JAM RAMAI === -->
    <div class="card shadow-sm border-0 rounded-3 mt-4 mb-5">
      <div class="card-body">
        <h5 class="fw-bold mb-4">üïí Jam Ramai</h5>
        <div class="chart-container" style="width: 100%; height: 350px;">
          <canvas id="peakHourChart"></canvas>
        </div>
        <p class="text-muted mt-3">
          Jam dengan pesanan terbanyak: <span id="jamRamaiText"><strong>{{ peak_hour or '-' }}</strong></span>
        </p>
      </div>
    </div>
  </main>
</div>

<!-- === CHART.JS === -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const dataYear = { labels: {{ years|tojson|safe }}, sales: {{ yearly_sales|tojson|safe }}, orders: {{ yearly_orders|tojson|safe }} };
  const dataMonth = { labels: {{ months|tojson|safe }}, sales: {{ monthly_sales|tojson|safe }}, orders: {{ monthly_orders|tojson|safe }} };
  const dataWeek = { labels: {{ week_days|tojson|safe }}, sales: {{ week_sales|tojson|safe }}, orders: {{ week_orders|tojson|safe }} };
  const dataDay = { labels: ["Hari Ini"], sales: [{{ daily_sales or 0 }}], orders: [{{ daily_orders or 0 }}] };

  function updateSummary(type, salesData, orderData) {
    const totalSales = salesData.reduce((a, b) => a + b, 0);
    const totalOrders = orderData.reduce((a, b) => a + b, 0);
    document.getElementById("summarySales").innerHTML = `Total Penjualan: <strong>Rp ${totalSales.toLocaleString("id-ID")}</strong>`;
    document.getElementById("summaryOrders").innerHTML = `Total Pesanan: <strong>${totalOrders}</strong> Order`;
  }

  // === Grafik Penjualan ===
  const salesCtx = document.getElementById('salesChart').getContext('2d');
  const salesChart = new Chart(salesCtx, {
    type: 'line',
    data: { labels: dataDay.labels, datasets: [{ label: 'Total Penjualan (Rp)', data: dataDay.sales, borderColor: '#ff7b00', backgroundColor: 'rgba(255,123,0,0.2)', borderWidth: 2, tension: 0.3, fill: true }] },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });

  // === Grafik Pesanan ===
  const orderCtx = document.getElementById('ordersChart').getContext('2d');
  const ordersChart = new Chart(orderCtx, {
    type: 'line',
    data: { labels: dataDay.labels, datasets: [{ label: 'Jumlah Pesanan', data: dataDay.orders, borderColor: '#007bff', backgroundColor: 'rgba(0,123,255,0.1)', borderWidth: 2, tension: 0.3, fill: true }] },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });

  // === Filter Chart + Update Summary ===
  const filters = { btnYear: dataYear, btnMonth: dataMonth, btnWeek: dataWeek, btnDay: dataDay };
  Object.keys(filters).forEach(id => {
    document.getElementById(id).addEventListener('click', function() {
      // üîÑ Ubah tampilan tombol aktif
      document.querySelectorAll('.btn-filter').forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');

      // === üìä Update grafik penjualan & pesanan ===
      const newData = filters[id];
      salesChart.data.labels = newData.labels;
      salesChart.data.datasets[0].data = newData.sales;
      salesChart.update();
      ordersChart.data.labels = newData.labels;
      ordersChart.data.datasets[0].data = newData.orders;
      ordersChart.update();
      updateSummary(id, newData.sales, newData.orders);

      // === üçï Update distribusi menu ===
      const menuKey = id.replace("btn", "btnMenu"); // otomatis ubah btnYear -> btnMenuYear
      const newMenuData = menuDataSets[menuKey];
      if (newMenuData) {
        menuChart.data.labels = newMenuData.labels;
        menuChart.data.datasets[0].data = newMenuData.data;
        menuChart.update();
        updateMenuList(newMenuData.labels, newMenuData.data);
      }

      // === üïí Update grafik jam ramai ===
      const newPeak = peakData[id];
      peakChart.data.labels = [...Array(24).keys()].map(h => `${h.toString().padStart(2, '0')}:00`);
      peakChart.data.datasets[0].data = newPeak;
      peakChart.update();

      // üß† Update teks jam paling ramai
      const maxIndex = newPeak.indexOf(Math.max(...newPeak));
      const jamRamai = maxIndex >= 0 && newPeak[maxIndex] > 0 
        ? `${String(maxIndex).padStart(2, '0')}:00`
        : '-';
      document.querySelector("#jamRamaiText").innerHTML = `<strong>${jamRamai}</strong>`;
    });
  });

  // === DATA DISTRIBUSI MENU ===
  const menuDataSets = {
    btnMenuYear: { labels: {{ menu_year_labels|tojson|safe }}, data: {{ menu_year_counts|tojson|safe }} },
    btnMenuMonth: { labels: {{ menu_month_labels|tojson|safe }}, data: {{ menu_month_counts|tojson|safe }} },
    btnMenuWeek: { labels: {{ menu_week_labels|tojson|safe }}, data: {{ menu_week_counts|tojson|safe }} },
    btnMenuDay: { labels: {{ menu_day_labels|tojson|safe }}, data: {{ menu_day_counts|tojson|safe }} },
  };

  // === Inisialisasi Chart ===
  const menuCtx = document.getElementById('menuChart').getContext('2d');
  let menuChart = new Chart(menuCtx, {
    type: 'doughnut',
    data: {
      labels: menuDataSets.btnMenuDay.labels,
      datasets: [{
        label: 'Jumlah Terjual',
        data: menuDataSets.btnMenuDay.data,
        backgroundColor: ['#E63946', '#457B9D', '#2A9D8F', '#F4A261', '#8A2BE2', '#FFB703', '#1D3557'],
        borderColor: '#fff',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      animation: { duration: 1200 },
      plugins: {
        legend: { position: 'right' },
        datalabels: {
          color: '#fff',
          font: { weight: 'bold', size: 13 },
          formatter: (v, ctx) => ((v / ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0)) * 100).toFixed(1) + '%'
        }
      }
    },
    plugins: [ChartDataLabels]
  });

  // === Update daftar menu samping ===
  function updateMenuList(labels, data) {
    const list = labels.map((label, i) => `<li class="mb-1"><strong>${label}</strong> ‚Äî ${data[i]} terjual</li>`).join('');
    document.getElementById("menuList").innerHTML = list || "<li>Belum ada data</li>";
  }
  updateMenuList(menuDataSets.btnMenuDay.labels, menuDataSets.btnMenuDay.data);
  
  // === GRAFIK JAM RAMAI ===
  const peakCtx = document.getElementById('peakHourChart').getContext('2d');

  // Dataset per periode
  const peakYear = {{ peak_hours_year|tojson|safe }};
  const peakMonth = {{ peak_hours_month|tojson|safe }};
  const peakWeek = {{ peak_hours_week|tojson|safe }};
  const peakDay = {{ peak_hours_day|tojson|safe }};

  const peakData = { 
    btnYear: peakYear, 
    btnMonth: peakMonth, 
    btnWeek: peakWeek, 
    btnDay: peakDay 
  };

  let peakChart = new Chart(peakCtx, {
    type: 'bar',
    data: {
      labels: [...Array(24).keys()].map(h => `${h.toString().padStart(2, '0')}:00`),
      datasets: [{
        label: 'Jumlah Pesanan',
        data: peakDay,
        backgroundColor: 'rgba(255,123,0,0.6)',
        borderColor: '#ff7b00',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } }
    }
  });

  // Set teks jam ramai awal (saat pertama kali halaman dimuat)
  const maxIndexInit = peakDay.indexOf(Math.max(...peakDay));
  const jamRamaiInit = maxIndexInit >= 0 && peakDay[maxIndexInit] > 0
    ? `${String(maxIndexInit).padStart(2, '0')}:00`
    : '-';
  document.querySelector("#jamRamaiText").innerHTML = `<strong>${jamRamaiInit}</strong>`;
  
});
</script>

<style>
.text-orange { color: #ff7b00; }
.btn-filter { background-color: #ddd; color: #333; font-weight: 500; }
.btn-filter.active { background-color: #ff7b00 !important; color: #fff !important; }
.chart-container { display: flex; align-items: center; justify-content: center; }
@media (min-width: 768px) { .d-flex.flex-md-row { gap: 1rem !important; } }
@media (max-width: 767px) { .chart-container { width: 90% !important; margin-bottom: 1rem; } }
</style>
{% endblock %}
